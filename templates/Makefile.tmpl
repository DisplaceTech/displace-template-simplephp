# {{.ProjectName}} Simple PHP Makefile
# Cross-platform support for Linux and macOS

# Load environment variables from .credentials if it exists
ifneq (,$(wildcard .credentials))
    include .credentials
    export
endif

# Default values
PROJECT_NAME ?= {{.ProjectName}}
NAMESPACE ?= {{.Namespace}}
DOMAIN ?= {{.Domain}}
IMAGE_TAG ?= latest
REGISTRY_URL ?=
KUBECTL ?= kubectl
DOCKER ?= docker

# Detect OS for cross-platform compatibility
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    OPEN_CMD = open
else
    OPEN_CMD = xdg-open
endif

# Colors for output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

.DEFAULT_GOAL := help

##@ Help
.PHONY: help
help: ## Display this help
	@awk 'BEGIN {FS = ":.*##"; printf "\n$(BLUE)Usage:$(NC)\n  make $(YELLOW)<target>$(NC)\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(BLUE)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Development
.PHONY: build
build: ## Build the Docker image locally
	@echo "$(BLUE)Building Docker image...$(NC)"
	@$(DOCKER) build -t $(PROJECT_NAME):$(IMAGE_TAG) .
	@if [ -n "$(REGISTRY_URL)" ]; then \
		$(DOCKER) tag $(PROJECT_NAME):$(IMAGE_TAG) $(REGISTRY_URL)/$(PROJECT_NAME):$(IMAGE_TAG); \
	fi
	@echo "$(GREEN)Build completed!$(NC)"

.PHONY: dev
dev: ## Start local development with docker-compose
	@echo "$(BLUE)Starting local development environment...$(NC)"
	@$(DOCKER) compose up -d
	@echo "$(GREEN)Development server running at http://localhost:8080$(NC)"

.PHONY: dev-down
dev-down: ## Stop local development environment
	@echo "$(BLUE)Stopping development environment...$(NC)"
	@$(DOCKER) compose down
	@echo "$(GREEN)Development environment stopped$(NC)"

.PHONY: dev-logs
dev-logs: ## View local development logs
	@$(DOCKER) compose logs -f

##@ Deployment
.PHONY: deploy
deploy: ## Deploy to Kubernetes with content sync
	@echo "$(BLUE)Deploying to Kubernetes...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project deploy; \
	else \
		echo "$(YELLOW)Displace CLI not found, using kubectl...$(NC)"; \
		$(KUBECTL) apply -f manifests/; \
	fi
	@echo "$(BLUE)Waiting for pods to be ready...$(NC)"
	@$(KUBECTL) wait --for=condition=available deployment/$(PROJECT_NAME) -n $(NAMESPACE) --timeout=120s
	@echo "$(BLUE)Syncing content to deployed pods...$(NC)"
	@make sync-content
	@echo ""
	@echo "$(GREEN)Deployment and content sync completed!$(NC)"
	@echo ""
	@echo "$(BLUE)Access your site:$(NC)"
	@echo "  $(YELLOW)Local access:$(NC) Run 'make port-forward' then visit http://localhost:8080"
	@echo "  $(YELLOW)Health check:$(NC) http://localhost:8080/health"
	@if $(KUBECTL) get ingress -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) >/dev/null 2>&1; then \
		echo "  $(YELLOW)Ingress URL:$(NC) https://$(DOMAIN)"; \
	fi
	@echo ""
	@echo "$(BLUE)Next steps:$(NC)"
	@echo "  - Edit PHP files in './public/' directory"
	@echo "  - Run 'make sync-content' to update the live site"
	@echo "  - Run 'make status' to check deployment health"

.PHONY: destroy
destroy: ## Remove deployment from Kubernetes
	@echo "$(RED)Destroying deployment...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project destroy; \
	else \
		echo "$(YELLOW)Displace CLI not found, using kubectl...$(NC)"; \
		$(KUBECTL) delete -f manifests/ --ignore-not-found; \
	fi
	@echo "$(GREEN)Deployment removed!$(NC)"

##@ Content Management
.PHONY: sync-content
sync-content: ## Sync local content to running pods (no rebuild required)
	@echo "$(BLUE)Syncing content to running pods...$(NC)"
	@PODS=$$($(KUBECTL) get pods -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) -o jsonpath='{.items[*].metadata.name}'); \
	if [ -z "$$PODS" ]; then \
		echo "$(RED)No running pods found for $(PROJECT_NAME) in namespace=$(NAMESPACE)$(NC)"; \
		exit 1; \
	fi; \
	for pod in $$PODS; do \
		echo "$(YELLOW)Syncing to pod: $$pod$(NC)"; \
		$(KUBECTL) cp public/. $(NAMESPACE)/$$pod:/var/www/html/; \
	done
	@echo "$(GREEN)Content sync completed!$(NC)"

.PHONY: backup-content
backup-content: ## Backup content from running pod to local directory
	@echo "$(BLUE)Backing up content from pod...$(NC)"
	@mkdir -p backups/content-$$(date +%Y%m%d-%H%M%S)
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) cp $(NAMESPACE)/$$POD:/var/www/html/ backups/content-$$(date +%Y%m%d-%H%M%S)/; \
		echo "$(GREEN)Content backed up to backups/content-$$(date +%Y%m%d-%H%M%S)/$(NC)"; \
	else \
		echo "$(RED)No running pods found$(NC)"; \
	fi

##@ Monitoring
.PHONY: status
status: ## Check deployment status
	@echo "$(BLUE)Checking deployment status...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project info; \
	else \
		echo "$(YELLOW)Namespace:$(NC)"; \
		$(KUBECTL) get namespace $(NAMESPACE) 2>/dev/null || echo "$(RED)Namespace not found$(NC)"; \
		echo "\n$(YELLOW)Deployments:$(NC)"; \
		$(KUBECTL) get deployments -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No deployments found$(NC)"; \
		echo "\n$(YELLOW)Pods:$(NC)"; \
		$(KUBECTL) get pods -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No pods found$(NC)"; \
		echo "\n$(YELLOW)Services:$(NC)"; \
		$(KUBECTL) get services -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No services found$(NC)"; \
		echo "\n$(YELLOW)PVCs:$(NC)"; \
		$(KUBECTL) get pvc -n $(NAMESPACE) 2>/dev/null || echo "$(RED)No PVCs found$(NC)"; \
		echo "\n$(YELLOW)Ingress:$(NC)"; \
		$(KUBECTL) get ingress -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No ingress found$(NC)"; \
	fi

.PHONY: logs
logs: ## View application logs
	@echo "$(BLUE)Viewing logs for $(PROJECT_NAME)...$(NC)"
	@$(KUBECTL) logs -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) -f --tail=100

.PHONY: events
events: ## View recent events for the namespace
	@echo "$(BLUE)Recent events in namespace $(NAMESPACE):$(NC)"
	@$(KUBECTL) get events -n $(NAMESPACE) --sort-by='.lastTimestamp' | tail -20

##@ Access
.PHONY: shell
shell: ## Access a running pod shell
	@echo "$(BLUE)Opening shell in pod...$(NC)"
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) exec -it -n $(NAMESPACE) $$POD -- /bin/sh; \
	else \
		echo "$(RED)No running pods found$(NC)"; \
	fi

.PHONY: port-forward
port-forward: ## Forward local port 8080 to service
	@echo "$(BLUE)Port forwarding to service (http://localhost:8080)...$(NC)"
	@echo "$(YELLOW)Press Ctrl+C to stop$(NC)"
	@$(KUBECTL) port-forward -n $(NAMESPACE) service/$(PROJECT_NAME) 8080:80

.PHONY: open
open: ## Open the website in browser (requires ingress or port-forward)
	@echo "$(BLUE)Opening https://$(DOMAIN) in browser...$(NC)"
	@$(OPEN_CMD) https://$(DOMAIN)

##@ Scaling
.PHONY: scale
scale: ## Scale replicas (usage: make scale REPLICAS=3)
	@if [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)Usage: make scale REPLICAS=3$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Scaling to $(REPLICAS) replicas...$(NC)"
	@$(KUBECTL) scale deployment $(PROJECT_NAME) -n $(NAMESPACE) --replicas=$(REPLICAS)
	@echo "$(GREEN)Scaled to $(REPLICAS) replicas$(NC)"

##@ Utilities
.PHONY: validate
validate: ## Validate Kubernetes manifests
	@echo "$(BLUE)Validating manifests...$(NC)"
	@for file in manifests/*.yaml; do \
		echo "$(YELLOW)Validating $$file$(NC)"; \
		$(KUBECTL) apply --dry-run=client -f "$$file" >/dev/null; \
	done
	@echo "$(GREEN)All manifests are valid!$(NC)"

.PHONY: info
info: ## Display project information
	@echo "$(BLUE)Project Information:$(NC)"
	@echo "  $(YELLOW)Project:$(NC) $(PROJECT_NAME)"
	@echo "  $(YELLOW)Namespace:$(NC) $(NAMESPACE)"
	@echo "  $(YELLOW)Domain:$(NC) $(DOMAIN)"
	@echo "  $(YELLOW)PHP Version:$(NC) {{.PHPVersion}}"
	@echo "  $(YELLOW)Image Tag:$(NC) $(IMAGE_TAG)"
	@echo "  $(YELLOW)Registry:$(NC) $(REGISTRY_URL)"
